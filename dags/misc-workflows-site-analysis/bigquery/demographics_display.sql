CREATE OR REPLACE TABLE
`{{ var.value.storage_project_id }}.{{ dag_run.conf['site_name'] }}.{{ params['visitors_demographics_table'] }}_display`
AS
SELECT
  *
EXCEPT
  (statistic),
  REPLACE(statistic, "delta_", "") AS statistic,
  CASE
    WHEN statistic IN (
      "white",
      "black_or_african_american",
      "american_indian_or_alaskan_native",
      "asian",
      "native_hawaiian_and_other_pacific_islander",
      "other_race",
      "two_or_more_races"
    ) THEN "race"
    WHEN statistic IN (
      "pop_0_10",
      "pop_10_to_19",
      "pop_20_to_29",
      "pop_30_to_39",
      "pop_40_to_49",
      "pop_50_to_59",
      "pop_60_to_69",
      "pop_70_to_79",
      "pop_80_plus"
    ) THEN "age"
    WHEN statistic IN (
      "income_000k_010k",
      "income_010k_015k",
      "income_015k_025k",
      "income_025k_035k",
      "income_035k_050k",
      "income_050k_075k",
      "income_075k_100k",
      "income_100k_150k",
      "income_150k_200k",
      "income_200k_plus"
    ) THEN "income"
    WHEN statistic IN (
      "delta_white",
      "delta_black_or_african_american",
      "delta_american_indian_or_alaskan_native",
      "delta_asian",
      "delta_native_hawaiian_and_other_pacific_islander",
      "delta_other_race",
      "delta_two_or_more_races"
    ) THEN "delta_race"
    WHEN statistic IN (
      "delta_pop_0_10",
      "delta_pop_10_to_19",
      "delta_pop_20_to_29",
      "delta_pop_30_to_39",
      "delta_pop_40_to_49",
      "delta_pop_50_to_59",
      "delta_pop_60_to_69",
      "delta_pop_70_to_79",
      "delta_pop_80_plus"
    ) THEN "delta_age"
    WHEN statistic IN (
      "delta_income_000k_010k",
      "delta_income_010k_015k",
      "delta_income_015k_025k",
      "delta_income_025k_035k",
      "delta_income_035k_050k",
      "delta_income_050k_075k",
      "delta_income_075k_100k",
      "delta_income_100k_150k",
      "delta_income_150k_200k",
      "delta_income_200k_plus"
    ) THEN "delta_income"
    WHEN statistic IN (
      "education_0_no_high_school",
      "education_1_high_school_grad",
      "education_2_asociate_degree",
      "education_3_bachelor_degree",
      "education_4_grad_or_prof_degree"
    ) THEN "education"
    WHEN statistic IN (
      "delta_education_0_no_high_school",
      "delta_education_1_high_school_grad",
      "delta_education_2_asociate_degree",
      "delta_education_3_bachelor_degree",
      "delta_education_4_grad_or_prof_degree"
    ) THEN "delta_education"
    WHEN statistic IN (
      "fk_life_stage_1",
      "fk_life_stage_2",
      "fk_life_stage_3",
      "fk_life_stage_4",
      "fk_life_stage_5"
    ) THEN "life_stage"
    WHEN statistic IN (
      "delta_fk_life_stage_1",
      "delta_fk_life_stage_2",
      "delta_fk_life_stage_3",
      "delta_fk_life_stage_4",
      "delta_fk_life_stage_5"
    ) THEN "delta_life_stage"
    WHEN statistic IN (
    "house_inc_per_0_none",
      "house_inc_per_1_u20",
      "house_inc_per_2_20_25",
      "house_inc_per_3_25_30",
      "house_inc_per_4_30_35",
      "house_inc_per_5_35p"
    ) THEN "house_inc_per"
    WHEN statistic IN (
      "pPropVal_1_uUSD10k",
    "pPropVal_2_USD10k_149k",
    "pPropVal_3_USD15k_19k",
    "pPropVal_4_USD20k_24k",
    "pPropVal_5_USD25k_29k",
    "pPropVal_6_USD30k_34k",
    "pPropVal_7_USD35k_39k",
    "pPropVal_8_USD40k_49k",
    "pPropVal_9_USD50k_59k",
    "pPropVal_10_USD60k_69k",
    "pPropVal_11_USD70k_79k",
    "pPropVal_12_USD80k_89k",
    "pPropVal_13_USD90k_99k",
    "pPropVal_14_USD100k_124k",
    "pPropVal_15_USD125k_149k",
    "pPropVal_16_USD150k_174k",
    "pPropVal_17_USD175k_199k",
    "pPropVal_18_USD200k_249k",
    "pPropVal_19_USD250k_299k",
    "pPropVal_20_USD300k_399k",
    "pPropVal_21_USD400k_499k",
    "pPropVal_22_USD500k_749k",
    "pPropVal_23_USD750k_999k",
    "pPropVal_24_USD1Mpl"
    ) THEN "prop_val"
    ELSE "unknown"
  END AS stats_group
FROM
  (
    SELECT
      delta_pop_0_10,
      delta_pop_10_to_19,
      delta_pop_20_to_29,
      delta_pop_30_to_39,
      delta_pop_40_to_49,
      delta_pop_50_to_59,
      delta_pop_60_to_69,
      delta_pop_70_to_79,
      delta_pop_80_plus,
      delta_income_000k_010k,
      delta_income_010k_015k,
      delta_income_015k_025k,
      delta_income_025k_035k,
      delta_income_035k_050k,
      delta_income_050k_075k,
      delta_income_075k_100k,
      delta_income_100k_150k,
      delta_income_150k_200k,
      delta_income_200k_plus,
      delta_white,
      delta_black_or_african_american,
      delta_american_indian_or_alaskan_native,
      delta_asian,
      delta_native_hawaiian_and_other_pacific_islander,
      delta_other_race,
      delta_two_or_more_races,
      education_0_no_high_school,
      education_1_high_school_grad,
      education_2_asociate_degree,
      education_3_bachelor_degree,
      education_4_grad_or_prof_degree,
      delta_education_0_no_high_school,
      delta_education_1_high_school_grad,
      delta_education_2_asociate_degree,
      delta_education_3_bachelor_degree,
      delta_education_4_grad_or_prof_degree,
      pop_0_10,
      pop_10_to_19,
      pop_20_to_29,
      pop_30_to_39,
      pop_40_to_49,
      pop_50_to_59,
      pop_60_to_69,
      pop_70_to_79,
      pop_80_plus,
      income_000k_010k,
      income_010k_015k,
      income_015k_025k,
      income_025k_035k,
      income_035k_050k,
      income_050k_075k,
      income_075k_100k,
      income_100k_150k,
      income_150k_200k,
      income_200k_plus,
      white,
      black_or_african_american,
      american_indian_or_alaskan_native,
      asian,
      native_hawaiian_and_other_pacific_islander,
      other_race,
      two_or_more_races,
      fk_life_stage_1,
      fk_life_stage_2,
      fk_life_stage_3,
      fk_life_stage_4,
      fk_life_stage_5,
      delta_fk_life_stage_1,
      delta_fk_life_stage_2,
      delta_fk_life_stage_3,
      delta_fk_life_stage_4,
      delta_fk_life_stage_5,
      house_inc_per_0_none,
      house_inc_per_1_u20,
      house_inc_per_2_20_25,
      house_inc_per_3_25_30,
      house_inc_per_4_30_35,
      house_inc_per_5_35p,
      pPropVal_uUSD10k AS pPropVal_1_uUSD10k,
    pPropVal_USD10k_149k AS pPropVal_2_USD10k_149k,
    pPropVal_USD15k_19k AS pPropVal_3_USD15k_19k,
    pPropVal_USD20k_24k AS pPropVal_4_USD20k_24k,
    pPropVal_USD25k_29k AS pPropVal_5_USD25k_29k,
    pPropVal_USD30k_34k AS pPropVal_6_USD30k_34k,
    pPropVal_USD35k_39k AS pPropVal_7_USD35k_39k,
    pPropVal_USD40k_49k AS pPropVal_8_USD40k_49k,
    pPropVal_USD50k_59k AS pPropVal_9_USD50k_59k,
    pPropVal_USD60k_69k AS pPropVal_10_USD60k_69k,
    pPropVal_USD70k_79k AS pPropVal_11_USD70k_79k,
    pPropVal_USD80k_89k AS pPropVal_12_USD80k_89k,
    pPropVal_USD90k_99k AS pPropVal_13_USD90k_99k,
    pPropVal_USD100k_124k AS pPropVal_14_USD100k_124k,
    pPropVal_USD125k_149k AS pPropVal_15_USD125k_149k,
    pPropVal_USD150k_174k AS pPropVal_16_USD150k_174k,
    pPropVal_USD175k_199k AS pPropVal_17_USD175k_199k,
    pPropVal_USD200k_249k AS pPropVal_18_USD200k_249k,
    pPropVal_USD250k_299k AS pPropVal_19_USD250k_299k,
    pPropVal_USD300k_399k AS pPropVal_20_USD300k_399k,
    pPropVal_USD400k_499k AS pPropVal_21_USD400k_499k,
    pPropVal_USD500k_749k AS pPropVal_22_USD500k_749k,
    pPropVal_USD750k_999k AS pPropVal_23_USD750k_999k,
    pPropVal_USD1Mpl AS pPropVal_24_USD1Mpl
    FROM
      `{{ var.value.storage_project_id }}.{{ dag_run.conf['site_name'] }}.{{ params['visitors_demographics_table'] }}`
  ) UNPIVOT(
    percentage FOR statistic IN (
      delta_pop_0_10,
      delta_pop_10_to_19,
      delta_pop_20_to_29,
      delta_pop_30_to_39,
      delta_pop_40_to_49,
      delta_pop_50_to_59,
      delta_pop_60_to_69,
      delta_pop_70_to_79,
      delta_pop_80_plus,
      delta_income_000k_010k,
      delta_income_010k_015k,
      delta_income_015k_025k,
      delta_income_025k_035k,
      delta_income_035k_050k,
      delta_income_050k_075k,
      delta_income_075k_100k,
      delta_income_100k_150k,
      delta_income_150k_200k,
      delta_income_200k_plus,
      delta_white,
      delta_black_or_african_american,
      delta_american_indian_or_alaskan_native,
      delta_asian,
      delta_native_hawaiian_and_other_pacific_islander,
      delta_other_race,
      delta_two_or_more_races,
      education_0_no_high_school,
      education_1_high_school_grad,
      education_2_asociate_degree,
      education_3_bachelor_degree,
      education_4_grad_or_prof_degree,
      delta_education_0_no_high_school,
      delta_education_1_high_school_grad,
      delta_education_2_asociate_degree,
      delta_education_3_bachelor_degree,
      delta_education_4_grad_or_prof_degree,
      pop_0_10,
      pop_10_to_19,
      pop_20_to_29,
      pop_30_to_39,
      pop_40_to_49,
      pop_50_to_59,
      pop_60_to_69,
      pop_70_to_79,
      pop_80_plus,
      income_000k_010k,
      income_010k_015k,
      income_015k_025k,
      income_025k_035k,
      income_035k_050k,
      income_050k_075k,
      income_075k_100k,
      income_100k_150k,
      income_150k_200k,
      income_200k_plus,
      white,
      black_or_african_american,
      american_indian_or_alaskan_native,
      asian,
      native_hawaiian_and_other_pacific_islander,
      other_race,
      two_or_more_races,
      fk_life_stage_1,
      fk_life_stage_2,
      fk_life_stage_3,
      fk_life_stage_4,
      fk_life_stage_5,
      delta_fk_life_stage_1,
      delta_fk_life_stage_2,
      delta_fk_life_stage_3,
      delta_fk_life_stage_4,
      delta_fk_life_stage_5,
      house_inc_per_0_none,
      house_inc_per_1_u20,
      house_inc_per_2_20_25,
      house_inc_per_3_25_30,
      house_inc_per_4_30_35,
      house_inc_per_5_35p,
      pPropVal_1_uUSD10k,
    pPropVal_2_USD10k_149k,
    pPropVal_3_USD15k_19k,
    pPropVal_4_USD20k_24k,
    pPropVal_5_USD25k_29k,
    pPropVal_6_USD30k_34k,
    pPropVal_7_USD35k_39k,
    pPropVal_8_USD40k_49k,
    pPropVal_9_USD50k_59k,
    pPropVal_10_USD60k_69k,
      pPropVal_11_USD70k_79k,
      pPropVal_12_USD80k_89k,
      pPropVal_13_USD90k_99k,
      pPropVal_14_USD100k_124k,
      pPropVal_15_USD125k_149k,
      pPropVal_16_USD150k_174k,
      pPropVal_17_USD175k_199k,
      pPropVal_18_USD200k_249k,
      pPropVal_19_USD250k_299k,
      pPropVal_20_USD300k_399k,
      pPropVal_21_USD400k_499k,
      pPropVal_22_USD500k_749k,
      pPropVal_23_USD750k_999k,
      pPropVal_24_USD1Mpl
    )
  )